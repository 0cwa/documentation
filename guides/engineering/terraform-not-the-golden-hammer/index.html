<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.50">
<link rel="preconnect" href="https://phprox.qovery.com">
<script>!function(t,e){var o,p,i,n;e.__SV||(window.posthog=e,e._i=[],e.init=function(r,s,c){function a(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(i=t.createElement("script")).type="text/javascript",i.async=!0,i.src=s.api_host+"/static/array.js",(n=t.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n);var g=e;for(void 0!==c?g=e[c]=[]:c="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==c&&(e+="."+c),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset".split(" "),p=0;p<o.length;p++)a(g,o[p]);e._i.push([r,s,c])},e.__SV=1)}(document,window.posthog||[]),posthog.init("phc_IgdG1K2GveDUte1gJ6hlwNbFHCv9nViWETUyLMU7ciq",{api_host:"https://phprox.qovery.com"})</script>
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Qovery Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Qovery Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css">
<script src="/js/intercom.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=UA-129773960-5" async></script>
<script src="/js/ga.js"></script>

<title data-react-helmet="true">Terraform is Not the Golden Hammer | Qovery</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Terraform is Not the Golden Hammer | Qovery"><meta data-react-helmet="true" name="description" content="Terraform is Not the Golden Hammer, in minutes, for free"><meta data-react-helmet="true" property="og:description" content="Terraform is Not the Golden Hammer, in minutes, for free"><meta data-react-helmet="true" property="og:image" content="https://hub.qovery.com/img/open-graph.png"><meta data-react-helmet="true" property="twitter:image" content="https://hub.qovery.com/img/open-graph.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Terraform is Not the Golden Hammer | Qovery"><meta data-react-helmet="true" property="og:url" content="https://docs.qovery.com/guides/engineering/terraform-not-the-golden-hammer/"><meta data-react-helmet="true" name="twitter:card" content="summary">

<link data-react-helmet="true" rel="shortcut icon" href="/img/logo-square.svg"><link data-react-helmet="true" rel="canonical" href="https://docs.qovery.com/guides/engineering/terraform-not-the-golden-hammer/">


<link rel="stylesheet" href="/styles.846259e1.css">


<link rel="preload" href="/styles.bd0e8e42.js" as="script">

<link rel="preload" href="/runtime~main.093c01fd.js" as="script">

<link rel="preload" href="/main.83dbfef0.js" as="script">

<link rel="preload" href="/1.e82d46e7.js" as="script">

<link rel="preload" href="/2.15d1d6ad.js" as="script">

<link rel="preload" href="/3.b23b9887.js" as="script">

<link rel="preload" href="/1c13b173.cb5984a5.js" as="script">

<link rel="preload" href="/241fc131.f8950722.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_2ZIa"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/">Guides</a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/guides/tutorial">Tutorials</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://discuss.qovery.com">Forum</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://console.qovery.com">Web Console</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://www.qovery.com">Home</a><a class="navbar__item navbar__link" title="GitHub" target="_blank" rel="noopener noreferrer" href="https://github.com/Qovery"><i class="feather icon-github"></i> </a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_16CL"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_34Mc moon_313u"></span></div><div class="react-toggle-track-x"><span class="toggle_34Mc sun_1Og-"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/">Guides</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" href="/guides/tutorial">Tutorials</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://discuss.qovery.com">Forum</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://console.qovery.com">Web Console</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://www.qovery.com">Home</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" title="GitHub" target="_blank" rel="noopener noreferrer" href="https://github.com/Qovery"></a></li></ul></div></div></div></nav><div class="main-wrapper"><header class="hero domain-bg domain-bg--default"><div class="container"><div class="hero--category"><a aria-current="page" class="active" href="/guides/engineering/">engineering</a></div><h1 class="header_1mJE">Terraform is Not the Golden Hammer</h1><div class="hero--subtitle">Feedbacks about mixed usages (Cloud Providers, Kubernetes...)</div><div class="tags_3AF9"><a class="badge badge--rounded badge--pink" href="/guides/tags/type-engineering/">type: engineering</a><a class="badge badge--rounded badge--primary" href="/guides/tags/technology-terraform/">technology: terraform</a></div></div></header><main class="container container--l container_1ncB"><aside class="sidebar_1pU0"><section class="avatar_1sJg"><div class="avatar avatar--lg avatar--vertical"><img class="avatar__photo avatar__photo--lg" src="https://github.com/deimosfr.png"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/deimosfr" target="_blank" rel="author">Pierre M.</a></div><small class="avatar__subtitle">Pierre is an SRE, and CTO of <a href="https://www.qovery.com">Qovery</a>. He has 15+ years of experience in R&D. From the financial to the Ad-Tech industry, he has a strong knowledge in distributed and highly-reliable systems. He's also the <a href="https://www.amazon.fr/MariaDB-High-Performance-Pierre-MAVRO/dp/1783981601">MariaDB High Performance</a> book author.
</small></div></div></section><section class="table-of-contents tableOfContents_1eMQ"><div class="section"><div class="title">Stats</div><div class="text--secondary text--bold"><i class="feather icon-book"></i> 9 min read</div><div class="text--secondary text--bold"><i class="feather icon-clock"></i> Updated <time pubdate="pubdate" datetime="2021-09-17">Sep 17th, 2021</time></div></div><div class="section"><div class="title">Contents</div><ul class="contents"><li><a href="#overview" class="contents__link">Overview</a></li><li><a href="#how-we-used-terraform" class="contents__link">How we used Terraform</a><ul><li><a href="#hcl" class="contents__link">HCL</a></li><li><a href="#gitops-and-team-usage" class="contents__link">GitOps and team usage</a></li><li><a href="#tfstate" class="contents__link">tfstate</a></li><li><a href="#helm-management" class="contents__link">Helm management</a></li></ul></li><li><a href="#problems-facing" class="contents__link">Problems facing</a><ul><li><a href="#heterogeneous-resources-management" class="contents__link">Heterogeneous resources management</a></li><li><a href="#too-strong-dependencies" class="contents__link">(Too) Strong dependencies</a></li><li><a href="#no-automatic-reconciliation" class="contents__link">No automatic reconciliation</a></li><li><a href="#automatic-import" class="contents__link">Automatic import</a></li></ul></li><li><a href="#advises-and-suggestion" class="contents__link">Advises and suggestion</a><ul><li><a href="#split" class="contents__link">Split</a></li><li><a href="#outsource" class="contents__link">Outsource</a></li></ul></li><li><a href="#conclusion" class="contents__link">Conclusion</a></li></ul></div></section></aside><div class="article_mCV7"><article><div class="markdown"><a aria-hidden="true" tabindex="-1" class="anchor" id="overview"></a><p>Terraform is probably the most used tool to deploy cloud services. It&#x27;s a fantastic tool, easily usable, with descriptive language (DSL) called HCL, team-oriented, supporting tons of cloud providers, etc.</p><p>On paper, it&#x27;s an attractive solution. And it&#x27;s easy to start delegating more and more responsibilities to Terraform, as it&#x27;s like a swiss knife; it knows how to perform several kinds of actions against several varieties of technologies.</p><p>Qovery is a platform to help developers to deploy their app on their cloud account in a few minutes (<a href="https://www.qovery.com/">check it out</a>). Before deploying an app, Qovery needs to deploy a few services (cloud provider side) where the app code will be hosted. To do so, we decided to use Terraform. The main reasons are:</p><ul><li>Terraform is the industry standard to deploy cloud services.</li><li>Qovery Engine is open source (<a href="https://github.com/Qovery/engine">https://github.com/Qovery/engine</a>), and we wanted to use something that anyone could easily contribute to.</li><li>Terraform is maintained by HashiCorp and by Cloud providers themself (trust of good quality and integration)</li></ul><p>At the beginning of Qovery, we took shortcuts. We needed to go fast. Using Terraform as the golden hammer was our shortcut. Based on our past experiences, we knew the golden hammer didn&#x27;t exist. We&#x27;ve seen many companies struggling when they start needing customization. In the end, you pay the price of using non-adapted tools!</p><p>So we were playing with the clock, as we knew it wouldn&#x27;t fit in the mid/long run but did not precisely know when it would happen.</p><p>This article is a return of experience, explaining where, when, and how you should use Terraform.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="how-we-used-terraform"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-we-used-terraform" title="Direct link to heading">#</a>How we used Terraform</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="hcl"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#hcl" title="Direct link to heading">#</a>HCL</h3><p>First thing to understand is how Terraform works. It&#x27;s a DSL as I mentionned earlier, the code looks like this:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-hcl codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">resource &quot;scaleway_k8s_cluster&quot; &quot;kubernetes_cluster&quot; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  name    = var.kubernetes_cluster_name</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  version = var.scaleway_ks_version</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  cni     = &quot;cilium&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  autoscaler_config {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    disable_scale_down = true</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    estimator = &quot;binpacking&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    scale_down_delay_after_add = &quot;10m&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    balance_similar_node_groups = true</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  auto_upgrade {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    enable = true</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    maintenance_window_day = &quot;any&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    maintenance_window_start_hour = 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><p>As you can see, it&#x27;s easily readable and understandable. It supports AWS, DigitalOcean, Scaleway, and so many other cloud providers.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="gitops-and-team-usage"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#gitops-and-team-usage" title="Direct link to heading">#</a>GitOps and team usage</h3><p>You can add this kind of code in a git repository and work with your team members on the same codebase.</p><p>When you run terraform against the Terraform code you&#x27;ve written, it will generate a tfstate file locally containing the information of what it has managed, keeping track of what it owns.</p><p>Working with Terraform in a team with parallel deployments is not the default Terraform behavior. You will have to configure a remote backend (s3+dynamodb, for example) to store the tfstate file.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-hcl codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">terraform {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  backend &quot;s3&quot; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    access_key = xxx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    secret_key = xxx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    bucket = xxx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    key =xxx.tfstate&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    dynamodb_table = xxx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    region = xxx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><p>You&#x27;ll then have a shared lock mechanism to avoid more than one person applying a change to the same resources.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="tfstate"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#tfstate" title="Direct link to heading">#</a>tfstate</h3><p>When you run terraform, it first refreshes the content of the state file, comparing what is deployed and what is stored into the tfstate file. It allows Terraform only to perform change actions on what is different from the tfstate file. It&#x27;s very efficient.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="helm-management"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#helm-management" title="Direct link to heading">#</a>Helm management</h3><p>Helm doesn&#x27;t only know how to work with several cloud providers but also knows how to talk to Kubernetes, Helm...the list is...HUGE! As you can see on the provider list (<a href="https://registry.terraform.io/browse/providers">https://registry.terraform.io/browse/providers</a>), there are +1.3k providers available!</p><p>So we were using it for Helm. Why? Because it&#x27;s super useful to create something on a cloud provider (like an IAM account), get the results from Terraform, and directly inject them as Helm variables.</p><p>To show how easy it is:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-hcl codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># Create user and attach policy</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_user&quot; &quot;iam_eks_loki&quot; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;qovery-logs-${var.kubernetes_cluster_id}&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  tags = local.tags_eks</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_access_key&quot; &quot;iam_eks_loki&quot; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  user    = aws_iam_user.iam_eks_loki.name</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_policy&quot; &quot;loki_s3_policy&quot; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  name = aws_iam_user.iam_eks_loki.name</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Policy for logs storage&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  policy = &lt;&lt;POLICY</span></div><div class="token-line" style="color:#393A34"><span class="token plain">{</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    &quot;Statement&quot;: [</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            &quot;Effect&quot;: &quot;Allow&quot;,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            &quot;Action&quot;: &quot;s3:*&quot;,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            &quot;Resource&quot;: &quot;*&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">POLICY</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_user_policy_attachment&quot; &quot;s3_loki_attachment&quot; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  user       = aws_iam_user.iam_eks_loki.name</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  policy_arn = aws_iam_policy.loki_s3_policy.arn</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># Deploy chart with user API credentials</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">resource &quot;helm_release&quot; &quot;loki&quot; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;loki&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  chart = &quot;common/charts/loki&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  namespace = &quot;logging&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  create_namespace = true</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  atomic = true</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  set {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;config.storage_config.aws.access_key_id&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    value = aws_iam_access_key.iam_eks_loki.id</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  set {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;config.storage_config.aws.secret_access_key&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    value = aws_iam_access_key.iam_eks_loki.secret</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    aws_iam_user.iam_eks_loki,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    aws_iam_access_key.iam_eks_loki,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    aws_s3_bucket.loki_bucket,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    aws_iam_policy.loki_s3_policy,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    aws_iam_user_policy_attachment.s3_loki_attachment,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    aws_eks_cluster.eks_cluster,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  ]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><p>And it supports the removal and upgrades for sure!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="problems-facing"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#problems-facing" title="Direct link to heading">#</a>Problems facing</h2><p>At this time, we had the golden hammer, we were super happy about what we achieved with the time invested. We were able to deploy on cloud providers (AWS/DigitalOcean), use Cloudflare, deploy with Helm and perform some operations with Kubernetes. Everything only with Terraform! So what could go wrong?</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="heterogeneous-resources-management"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#heterogeneous-resources-management" title="Direct link to heading">#</a>Heterogeneous resources management</h3><p>The way Terraform manages resources is not homogeneous. Here are a few examples:</p><ul><li>When you run Terraform against AWS on the subnets part, it will create (anytime you deploy) the missing subnets</li><li>For some resources like RDS or EKS, it won&#x27;t check if the resource already exists or not. So if it&#x27;s missing, nothing is going to happen as it&#x27;s marked are deployed in the tfstate file</li><li>Same for Helm chart deployed, for example, they are marked as deployed, so no update will be performed on it until you change something</li></ul><p>So until you experienced one of those cases, it&#x27;s hard to know if a resource (which is not there) will be re-created or not.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="too-strong-dependencies"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#too-strong-dependencies" title="Direct link to heading">#</a>(Too) Strong dependencies</h3><p>Let me give a frustrating example, let&#x27;s say I want to deploy:</p><ol><li>A Kubernetes cluster (EKS) on AWS</li><li>DNS name on Cloudflare</li><li>Helm charts on this EKS cluster</li></ol><p>I specify dependencies in Terraform with this exact order. I run the “terraform apply” command to deploy this stack. A few min later, wowww it works, that is amazing, I&#x27;m super excited!</p><p>A few days later, I need more resources, so I update the number of worker nodes in EKS. I run once again the “terraform apply” command. But for some reason, Cloudflare API doesn&#x27;t answer and I got completely stuck there without the possibility to update with Terraform this field because of linked dependencies.</p><p>Same for Helm, I&#x27;ve multiplied the number of charts I wanted to deploy. If for some reason I have a problem with some, I may be unable to update values I wanted to update on others&#x27; charts, even if it shouldn&#x27;t be that important.</p><p><strong>I just wanted a dependency order of deployment, not a so hard dependency between all of them for any kind of updates.</strong></p><p>The link between all declared is strong, so strong that you may be blocked until the problem is resolved (by a third-party provider or a manual fix from you). <strong>In case of issues, when you need to go fast, it can be a real issue, drastically slowing down the resolution of your problems.</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="no-automatic-reconciliation"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#no-automatic-reconciliation" title="Direct link to heading">#</a>No automatic reconciliation</h3><p>Those who already used a configuration manager (Puppet, Ansible, Chef…), are familiar with the automatic reconciliation. Just run it against your infrastructure, and you&#x27;ll be sure about the end result if you have any doubts. You&#x27;ll get what you&#x27;ve asked for!</p><p><strong>On terraform it&#x27;s different, because of the tfstate. All the deployed elements are stored in the tfstate, re-running terraform won&#x27;t update resources that are supposed to be in a specific state but are not.</strong></p><p>This is where the biggest behavior comes in with Terraform compared to configuration managers.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="automatic-import"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#automatic-import" title="Direct link to heading">#</a>Automatic import</h3><p>When you deploy resources and something goes wrong (like an API returns a timeout failure, but in the end, you have your resource deployed), Terraform won&#x27;t store the info in the state file as it shouldn&#x27;t exist. Unfortunately, the resource exists and next time you will run “terraform apply”, you&#x27;ll face a “resource already exists” message.</p><p>There is, unfortunately, no way to automatically recover it automatically. You need to “import” each resource one by one (<a href="https://www.terraform.io/docs/cli/commands/import.html">https://www.terraform.io/docs/cli/commands/import.html</a>).</p><p>This is not convenient at all if you have a team of dedicated Ops/DevOps/SRE managing it, who will fix it manually. But in the case your want it to be 100% automatic, it is a problem.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="advises-and-suggestion"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#advises-and-suggestion" title="Direct link to heading">#</a>Advises and suggestion</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="split"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#split" title="Direct link to heading">#</a>Split</h3><p>If you want to let Terraform manage several kinds of different resources, I strongly advise to split into different state files and do not link them all together.</p><p>This is not convenient at first because you&#x27;re losing the strong link between all of them, but you can overcome this issue with data sources (<a href="https://www.terraform.io/docs/language/data-sources/index.html">https://www.terraform.io/docs/language/data-sources/index.html</a>).</p><p>You&#x27;ll also need some tooling around it to manage the flow (in which order all of them have to run).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="outsource"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#outsource" title="Direct link to heading">#</a>Outsource</h3><p>This is the choice we&#x27;ve made at Qovery, we only kept the minimum useful to Terraform, so the Cloud part.</p><p>Everything Helm/Kubernetes related are managed by our Engine. This has a lot of advantages (will talk about it in a dedicated post):</p><ul><li>more flexibility</li><li>restricting Terraform to what he&#x27;s perfect at</li><li>linked resources are strong, and they are really strong cloud-only provider side</li><li>we better fine-grained manage helm lifecycle</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="conclusion"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#conclusion" title="Direct link to heading">#</a>Conclusion</h2><p>If today, someone is asking me: “Should I use Terraform to deploy cloud providers infrastructures or services?”. I would definitively say “YES”.</p><p>But I&#x27;ll mention that depending on how strong should be the automatization requested behind it, splitting or delegating some parts of what should be achieved. It has to come in the balance at a very early stage.</p><a aria-current="page" class="jump-to jump-to--undefined active" href="/guides/engineering/"><div class="jump-to--inner"><div class="jump-to--inner-2"><div class="jump-to--main">Engineering</div><div class="jump-to--right"><i class="feather icon-chevron-right arrow"></i></div></div></div></a></div></article></div></main></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col col--5 footer__col"><div class="margin-bottom--md"></div><div class="margin-bottom--md"><p>Qovery combines the power of Kubernetes, the reliability of AWS, and the simplicity of Heroku to deploy your apps.</p></div><div><a href="https://github.com/qovery" target="_blank"><i class="feather icon-github" alt="Qovery&#x27;s Github Repo"></i></a>    <a href="https://www.linkedin.com/company/qovery/" target="_blank"><i class="feather icon-rss" alt="Qovery&#x27;s Linkedin"></i></a>    <a href="https://twitter.com/qovery_" target="_blank"><i class="feather icon-twitter" alt="Qovery&#x27;s Twitter"></i></a>    <a href="https://discord.qovery.com" target="_blank"><i class="feather icon-message-circle" alt="Qovery&#x27;s Discord"></i></a></div></div><div class="col footer__col"><h4 class="footer__title">Resources</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs">Documentation</a></li><li class="footer__item"><a aria-current="page" class="footer__link-item active" href="/guides">Guides</a></li><li class="footer__item"><a class="footer__link-item" href="/guides/tutorial">Tutorials</a></li><li class="footer__item"><a aria-current="page" class="footer__link-item active" href="/guides/engineering">Engineering</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/pricing" href="https://www.qovery.com/pricing">Pricing</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/enterprise" href="https://www.qovery.com/enterprise">Enterprise</a></li><li class="footer__item"><a class="footer__link-item" to="https://api-doc.qovery.com" href="https://api-doc.qovery.com">API</a></li><li class="footer__item"><a class="footer__link-item" to="https://github.com/Qovery" href="https://github.com/Qovery">Github</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://discord.qovery.com" href="https://discord.qovery.com">Discord</a></li><li class="footer__item"><a class="footer__link-item" to="https://community.qovery.com" href="https://community.qovery.com">Forum</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/community-call" href="https://www.qovery.com/community-call">Community call</a></li><li class="footer__item"><a class="footer__link-item" to="https://shop.qovery.com" href="https://shop.qovery.com">Goodies</a></li><li class="footer__item"><a class="footer__link-item" to="https://roadmap.qovery.com" href="https://roadmap.qovery.com">Roadmap</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Company</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/blog" href="https://www.qovery.com/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" to="https://jobs.qovery.com" href="https://jobs.qovery.com">Jobs</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/team" href="https://www.qovery.com/team">Team</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/investors" href="https://www.qovery.com/investors">Investors</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/contact" href="https://www.qovery.com/contact">Contact</a></li></ul></div></div><div class="text--center"><small>© 2021 DESIGNED BY QOVERY | BACKED BY TECHSTARS | PROUD SILVER MEMBER OF CNCF AND LINUX FOUNDATION | QOVERY BY BIRDSIGHT - ALL RIGHTS RESERVED</small><br></div></div></footer>
</div>

<script src="/styles.bd0e8e42.js"></script>

<script src="/runtime~main.093c01fd.js"></script>

<script src="/main.83dbfef0.js"></script>

<script src="/1.e82d46e7.js"></script>

<script src="/2.15d1d6ad.js"></script>

<script src="/3.b23b9887.js"></script>

<script src="/1c13b173.cb5984a5.js"></script>

<script src="/241fc131.f8950722.js"></script>


</body>
</html>