<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.50">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Qovery Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Qovery Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css">

<title data-react-helmet="true">URL Shortener API with Kotlin | Qovery</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="URL Shortener API with Kotlin | Qovery"><meta data-react-helmet="true" name="description" content="URL Shortener API with Kotlin, in minutes, for free"><meta data-react-helmet="true" property="og:description" content="URL Shortener API with Kotlin, in minutes, for free"><meta data-react-helmet="true" property="og:image" content="https://docsv2.qovery.com/img/open-graph.png"><meta data-react-helmet="true" property="twitter:image" content="https://docsv2.qovery.com/img/open-graph.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for URL Shortener API with Kotlin | Qovery"><meta data-react-helmet="true" property="og:url" content="https://docs.qovery.com/guides/tutorial/url-shortener-api-with-kotlin/"><meta data-react-helmet="true" name="twitter:card" content="summary">

<link data-react-helmet="true" rel="shortcut icon" href="/img/logo-square.svg"><link data-react-helmet="true" rel="canonical" href="https://docs.qovery.com/guides/tutorial/url-shortener-api-with-kotlin/">


<link rel="stylesheet" href="/styles.cacae0fd.css">


<link rel="preload" href="/styles.7122513e.js" as="script">

<link rel="preload" href="/runtime~main.70364d68.js" as="script">

<link rel="preload" href="/main.68867a33.js" as="script">

<link rel="preload" href="/1.ccfb3ced.js" as="script">

<link rel="preload" href="/2.6fc22653.js" as="script">

<link rel="preload" href="/3.f93d080f.js" as="script">

<link rel="preload" href="/1c13b173.b03ba391.js" as="script">

<link rel="preload" href="/ab8f5b83.972544dc.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_2ZIa"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"></a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://www.qovery.com">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/">Guides</a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/community/"><i class="feather icon-users"></i> Community</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" title="GitHub" target="_blank" rel="noopener noreferrer" href="https://github.com/Qovery"><i class="feather icon-github"></i> </a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_16CL"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_34Mc moon_313u"></span></div><div class="react-toggle-track-x"><span class="toggle_34Mc sun_1Og-"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://www.qovery.com">Home</a></li><li class="menu__list-item"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/">Guides</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" href="/community/">Community</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" title="GitHub" target="_blank" rel="noopener noreferrer" href="https://github.com/Qovery"></a></li></ul></div></div></div></nav><div class="main-wrapper"><header class="hero domain-bg domain-bg--services"><div class="container"><div class="hero--category"><a aria-current="page" class="active" href="/guides/tutorial/">tutorial</a></div><h1 class="header_1mJE">URL Shortener API with Kotlin</h1><div class="hero--subtitle">Create a URL shortener API with Kotlin, the micro-framework Ktor and PostgreSQL</div><div class="tags_3AF9"><a class="badge badge--rounded badge--pink" href="/guides/tags/type-tutorial/">type: tutorial</a><a class="badge badge--rounded badge--blue" href="/guides/tags/domain-services/">domain: services</a></div></div></header><main class="container container--l container_1ncB"><aside class="sidebar_1pU0"><section class="avatar_1sJg"><div class="avatar avatar--lg avatar--vertical"><img class="avatar__photo avatar__photo--lg" src="https://github.com/evoxmusic.png"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/evoxmusic" target="_blank" rel="author">Romaric</a></div><small class="avatar__subtitle">Romaric is a Software Engineer and CEO at <a href="https://www.qovery.com">Qovery</a> </small></div></div></section><section class="table-of-contents tableOfContents_1eMQ"><div class="section"><div class="title">Stats</div><div class="text--secondary text--bold"><i class="feather icon-book"></i> 12 min read</div><div class="text--secondary text--bold"><i class="feather icon-clock"></i> Updated <time pubdate="pubdate" datetime="2020-04-19">Apr 19th, 2020</time></div></div><div class="section"><div class="title">Contents</div><ul class="contents"><li><a href="#overview" class="contents__link">Overview</a></li><li><a href="#introduction" class="contents__link">Introduction</a></li><li><a href="#what-is-a-url-shortener" class="contents__link">What is a URL shortener?</a></li><li><a href="#ktor-principles" class="contents__link">Ktor principles</a><ul><li><a href="#kotlin" class="contents__link">Kotlin</a></li><li><a href="#functional-programming" class="contents__link">Functional programming</a></li><li><a href="#asynchronous" class="contents__link">Asynchronous</a></li></ul></li><li><a href="#http-server" class="contents__link">HTTP Server</a></li><li><a href="#url-encoder" class="contents__link">URL Encoder</a><ul><li><a href="#handle-identifier-collision" class="contents__link">Handle identifier collision</a></li></ul></li><li><a href="#url-decoder" class="contents__link">URL Decoder</a></li><li><a href="#redirect" class="contents__link">Redirect</a></li><li><a href="#stats-clicks-over-time" class="contents__link">Stats: clicks over time</a></li><li><a href="#try-the-api" class="contents__link">Try the API</a></li><li><a href="#connect-to-a-postgresql-database-with-exposed" class="contents__link">Connect to a PostgreSQL database with Exposed</a></li><li><a href="#deploy-in-the-cloud-with-qovery" class="contents__link">Deploy in the Cloud with Qovery</a><ul><li><a href="#connect-to-postgresql" class="contents__link">Connect to PostgreSQL</a></li><li><a href="#deploy" class="contents__link">Deploy</a></li></ul></li><li><a href="#conclusion" class="contents__link">Conclusion</a></li></ul></div></section></aside><div class="article_mCV7"><article><div class="markdown"><a aria-hidden="true" tabindex="-1" class="anchor" id="overview"></a><p>The source code for this post can be found on this <a href="https://github.com/evoxmusic/ktor-url-shortener">github repo</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="introduction"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#introduction" title="Direct link to heading">#</a>Introduction</h2><p><a href="https://ktor.io/">Ktor</a> is a brand new micro-framework created by the Jetbrains team and running over the JVM. Jetbrains are the authors of <a href="https://kotlinlang.org/">Kotlin</a> - which is now the official programming language for Android, and one of the most popular programming language on the JVM. Kotlin is gaining popularity on server-side and multi-platform application development.</p><blockquote><p>Ktor is a framework for building asynchronous servers and clients in connected systems using the powerful Kotlin programming language.</p></blockquote><p>In this article you will learn:</p><ul><li>How to design a simple URL shortener.</li><li>How to use the Ktor micro-framework with Kotlin</li><li>How to deploy a Ktor application</li></ul><p>I personally have +4 years of experience using Spring and I wanted to give a try to Ktor which seems promising. Creating a URL shortener is a good way to start.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="what-is-a-url-shortener"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#what-is-a-url-shortener" title="Direct link to heading">#</a>What is a URL shortener?</h2><p>A URL shortener is a simple tool that takes a long URL and turns it into a very short one</p><p><img src="https://uploads-ssl.webflow.com/5de176c0d41c9b4a1dbbb0aa/5e655859bc2ae5c7371efa36_urlshortener%20image.png" alt="Flow of URL shortening - from original URL to short URL"></p><p>It is commonly used for 3 reasons:</p><ul><li>Tracking clicks</li><li>Make URL much more concise.</li><li>Hide original URL</li></ul><p>One famous freemium provider is bit.ly (see <a href="https://uploads-ssl.webflow.com/5de176c0d41c9b4a1dbbb0aa/5e655a34bc2ae5452b1f124b_bitly.gif">here</a>)</p><p>In this article we will make a basic bit.ly like URL shortener. Let’s go</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="ktor-principles"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#ktor-principles" title="Direct link to heading">#</a>Ktor principles</h2><p>Before starting I want to introduce the 3 main principles of Ktor.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="kotlin"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#kotlin" title="Direct link to heading">#</a>Kotlin</h3><p>Kotlin is the language used to develop on Ktor. It is an object-oriented and functional language. It is very stable and runs on the JVM. Kotlin is 100% interoperable with Java and allows you to benefit from its ecosystem (libraries, build system, etc.).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="functional-programming"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#functional-programming" title="Direct link to heading">#</a>Functional programming</h3><p>Ktor leverages the power of Kotlin and has a very functional approach. When writing code, everything seems obvious. It&#x27;s very similar to what you can see on NodeJS. For me, coming from the Spring world, I find it very efficient to read and use.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="asynchronous"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#asynchronous" title="Direct link to heading">#</a>Asynchronous</h3><p>Kotlin provides asynchronous code execution, thanks to <a href="https://kotlinlang.org/docs/reference/coroutines-overview.html">coroutines</a>. Ktor exploits this feature to its full potential, and even if you have the impression that you are writing code in a blocking manner, this is not the case. Ktor makes your life easier.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="http-server"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#http-server" title="Direct link to heading">#</a>HTTP Server</h2><p>Here is a complete and simple example of how to expose an HTTP server (<a href="http://localhost:8080">http://localhost:8080</a>) with Ktor.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">fun main(args: Array&lt;String&gt;): Unit = io.ktor.server.netty.EngineMain.main(args)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">@kotlin.jvm.JvmOverloads</span></div><div class="token-line" style="color:#393A34"><span class="token plain">fun Application.module(testing: Boolean = false) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    routing {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        get(&quot;/&quot;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            call.respondText(&quot;Hello World&quot;, contentType = ContentType.Text.Plain)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="url-encoder"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#url-encoder" title="Direct link to heading">#</a>URL Encoder</h2><p>The URL encoder will translate an incoming address into a smaller URL. The idea is to provide an ID that will identify the final URL. Using a hash function is perfect for this operation. However, the operation is non-reversible, meaning you can’t retrieve the final URL by the generated identifier.</p><p>Function to transform a long URL into a shorter URL</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">// String extension</span></div><div class="token-line" style="color:#393A34"><span class="token plain">fun String.encodeToID(): String {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // hash String with MD5</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val hashBytes = MessageDigest.getInstance(&quot;MD5&quot;).digest(this.toByteArray(Charsets.UTF_8))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // transform to human readable MD5 String</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val hashString = String.format(&quot;%032x&quot;, BigInteger(1, hashBytes))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // truncate MD5 String</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val truncatedHashString = hashString.take(6)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // return id</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return truncatedHashString</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><p>We expose the function through the REST API</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">// Request object</span></div><div class="token-line" style="color:#393A34"><span class="token plain">data class Request(val url: String) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    fun toResponse(): Response = Response(url, url.encodeToID())</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">// Response object</span></div><div class="token-line" style="color:#393A34"><span class="token plain">data class Response(val originalURL: String, private val id: String) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val shortURL: String = &quot;http://localhost:8080/$id&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">@kotlin.jvm.JvmOverloads</span></div><div class="token-line" style="color:#393A34"><span class="token plain">fun Application.module(testing: Boolean = false) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    install(ContentNegotiation) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        jackson {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            enable(SerializationFeature.INDENT_OUTPUT)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            propertyNamingStrategy = PropertyNamingStrategy.SNAKE_CASE</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // Hash Table Response object by ID</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val responseByID = mutableMapOf&lt;String, Response&gt;()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    routing {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        post(&quot;/api/v1/encode&quot;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // Deserialize JSON body to Request object</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val request = call.receive&lt;Request&gt;()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // find the Response object if it already exists</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val retrievedResponse = responseByID[request.url.encodeToID()]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (retrievedResponse != null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // cache hit</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                log.debug(&quot;cache hit $retrievedResponse&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return@post call.respond(retrievedResponse)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // cache miss</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val response = request.toResponse()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            responseByID[request.url.encodeToID()] = response</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;cache miss $response&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // Serialize Response object to JSON body</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            call.respond(response)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="handle-identifier-collision"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#handle-identifier-collision" title="Direct link to heading">#</a>Handle identifier collision</h3><p>Using a hash function makes no guarantee that it is not already being used. If it is in use, then you need to change it to another one. Note: even if the probability to have a collision is very low, you should handle this case.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">// String extension (function signature has changed)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">fun String.encodeToID(truncateLength: Int = 6): String {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // hash String with MD5</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val hashBytes = MessageDigest.getInstance(&quot;MD5&quot;).digest(this.toByteArray(Charsets.UTF_8))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // transform to human readable MD5 String</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val hashString = String.format(&quot;%032x&quot;, BigInteger(1, hashBytes))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // truncate MD5 String</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val truncatedHashString = hashString.take(truncateLength)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // return id</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return truncatedHashString</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">//...</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">@kotlin.jvm.JvmOverloads</span></div><div class="token-line" style="color:#393A34"><span class="token plain">fun Application.module(testing: Boolean = false) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // Hash Table Response object by id</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val responseByID = mutableMapOf&lt;String, Response&gt;()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    fun getIdentifier(url: String, truncateLength: Int = 6): String {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        val id = url.encodeToID()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        val retrievedResponse = responseByID[id]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (retrievedResponse?.originalURL != url) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // collision spotted !</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return getIdentifier(url, truncateLength + 1)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return id</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    routing {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        post(&quot;/api/v1/encode&quot;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // Deserialize JSON body to Request object</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val request = call.receive&lt;Request&gt;()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // find the Response object if it already exists</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val id = getID(request.url)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val retrievedResponse = responseByID[id]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (retrievedResponse != null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // cache hit</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                log.debug(&quot;cache hit $retrievedResponse&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return@post call.respond(retrievedResponse)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // cache miss</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val response = request.toResponse()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            responseByID[id] = response</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;cache miss $response&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // Serialize Response object to JSON body</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            call.respond(response)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="url-decoder"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#url-decoder" title="Direct link to heading">#</a>URL Decoder</h2><p>Decoding the URL is the process of returning the original URL from the short URL. This is the reverse operation made by the URL Encoder</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">val shortURL = getShortURL(request.url)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">val retrievedResponse = responseByID[shortURL]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">retrievedResponse?.originalURL // return original URL or null</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="redirect"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#redirect" title="Direct link to heading">#</a>Redirect</h2><p>When a user clicks on a short URL, the user is redirected to the final URL. HTTP protocol allows to do this naturally by returning a 302 status code and a redirection URL.</p><p>With Ktor the redirection is as simple as calling a method with the final URL as a parameter.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">call.respondRedirect(&quot;https://www.qovery.com&quot;)</span></div></div></pre></div></div><p>What we expect is that when the user visits <a href="http://localhost:8080/fbc951">http://localhost:8080/fbc951</a> he is redirected to <a href="https://www.qovery.com">https://www.qovery.com</a>. If the URL is incorrect then redirect to <a href="https://www.google.com">https://www.google.com</a></p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">@kotlin.jvm.JvmOverloads</span></div><div class="token-line" style="color:#393A34"><span class="token plain">fun Application.module(testing: Boolean = false) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    routing {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        get(&quot;/{id}&quot;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val id = call.parameters[&quot;id&quot;]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val retrievedResponse = id?.let { responseByID[it] }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (id.isNullOrBlank() || retrievedResponse == null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return@get call.respondRedirect(&quot;https://www.google.com&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;redirect to: $retrievedResponse&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            call.respondRedirect(retrievedResponse.originalURL)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="stats-clicks-over-time"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#stats-clicks-over-time" title="Direct link to heading">#</a>Stats: clicks over time</h2><p>Something that is really useful on products like bit.ly is the stats provided (click over time, referrers, country of visitors). Here is how to store click over time and make them available through the API</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">// added</span></div><div class="token-line" style="color:#393A34"><span class="token plain">data class Stat(val clicksOverTime: MutableList&lt;Date&gt; = mutableListOf())</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">// Response object (modified with Stat)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">data class Response(val originalURL: String, private val id: String, val stat: Stat = Stat()) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val shortURL: String = &quot;http://localhost:8080/$id&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">@kotlin.jvm.JvmOverloads</span></div><div class="token-line" style="color:#393A34"><span class="token plain">fun Application.module(testing: Boolean = false) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        install(ContentNegotiation) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        jackson {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // add this line to return Date object as ISO8601 format</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    routing {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        get(&quot;/api/v1/url/{id}/stat&quot;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val id = call.parameters[&quot;id&quot;]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val retrievedResponse = id?.let { responseByID[it] }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (id.isNullOrBlank() || retrievedResponse == null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return@get call.respond(HttpStatusCode.NoContent)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            call.respond(retrievedResponse.stat)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="try-the-api"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#try-the-api" title="Direct link to heading">#</a>Try the API</h2><p>Run the application</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">$ ./gradlew run</span></div><div class="token-line" style="color:#393A34"><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2020</span><span class="token plain">-03-12 09:28:08.150 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> INFO  Application - No ktor.deployment.watch patterns specified, automatic reload is not active</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2020</span><span class="token plain">-03-12 09:28:08.606 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> INFO  Application - Responding at http://0.0.0.0:8080</span></div></div></pre></div></div><p>Then execute the commands</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># generate a short URL</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X POST -d </span><span class="token string" style="color:#e3116c">&#x27;{&quot;url&quot;: &quot;https://www.qovery.com&quot;}&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&quot;Content-type: application/json&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://localhost:8080/api/v1/encode&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;original_url&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://www.qovery.com&quot;</span><span class="token plain">,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;stat&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;clicks_over_time&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;short_url&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://localhost:8080/fbc951&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># generate 4 fake clicks</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET </span><span class="token string" style="color:#e3116c">&#x27;http://localhost:8080/fbc951&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET </span><span class="token string" style="color:#e3116c">&#x27;http://localhost:8080/fbc951&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET </span><span class="token string" style="color:#e3116c">&#x27;http://localhost:8080/fbc951&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET </span><span class="token string" style="color:#e3116c">&#x27;http://localhost:8080/fbc951&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># show stat</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET </span><span class="token string" style="color:#e3116c">&#x27;http://localhost:8080/api/v1/url/fbc951/stat&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;clicks_over_time&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;2020-03-11T21:10:52.354+0000&quot;</span><span class="token plain">,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;2020-03-11T21:10:54.093+0000&quot;</span><span class="token plain">,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;2020-03-11T21:12:34.987+0000&quot;</span><span class="token plain">,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;2020-03-11T21:12:37.223+0000&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="connect-to-a-postgresql-database-with-exposed"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#connect-to-a-postgresql-database-with-exposed" title="Direct link to heading">#</a>Connect to a PostgreSQL database with Exposed</h2><p>By storing the data in memory, we lose all the data every time the application restart. Which is problematic for running in production. To make the data persistent we will store it in a PostgreSQL database. We will have to add 1 new dependency - <a href="https://github.com/JetBrains/Exposed">Exposed</a>. Exposed (with <a href="https://github.com/brettwooldridge/HikariCP">Hikari Connection Pool</a>) is a lightweight SQL library on top of JDBC driver for Kotlin. With exposed it is possible to access databases in two flavours: typesafe SQL wrapping DSL and lightweight Data Access Objects (DAO).</p><p>Add the dependencies to your build.gradle (or POM.xml)</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">repositories {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  jcenter()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  // Connection Pool and PostgreSQL driver</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  implementation(&quot;com.zaxxer:HikariCP:3.4.2&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  implementation(&quot;org.postgresql:postgresql:42.2.11&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  // Exposed</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  implementation(&quot;org.jetbrains.exposed:exposed-core:0.22.1&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  implementation(&quot;org.jetbrains.exposed:exposed-dao:0.22.1&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  implementation(&quot;org.jetbrains.exposed:exposed-jdbc:0.22.1&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  implementation(&quot;org.jetbrains.exposed:exposed-java-time:0.22.1&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><p>We need to have 2 distincts tables, one containing all the final URLs with their correspond identifier</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">object ResponseTable : Table(&quot;response&quot;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val id = varchar(&quot;id&quot;, 32)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val originalURL = varchar(&quot;original_url&quot;, 2048)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    override val primaryKey: PrimaryKey = PrimaryKey(id)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><p>And a second one with all the clicking points</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">object ClickOverTimeTable : Table(&quot;click_over_time&quot;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val id = integer(&quot;id&quot;).autoIncrement()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val clickDate = datetime(&quot;click_date&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val response = reference(&quot;response_id&quot;, onDelete = ReferenceOption.CASCADE, refColumn = ResponseTable.id)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    override val primaryKey: PrimaryKey = PrimaryKey(id)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><p>We need to create the tables as defined above programmatically</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">fun initDatabase() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val config = HikariConfig().apply {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        jdbcUrl = &quot;jdbc:postgresql://127.0.0.1:5432/exposed&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        username = &quot;exposed&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        password = &quot;exposed&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        driverClassName = &quot;org.postgresql.Driver&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Database.connect(HikariDataSource(config))</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transaction {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // create tables if they do not exist</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        SchemaUtils.createMissingTablesAndColumns(RequestTable, ClickOverTimeTable)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">@kotlin.jvm.JvmOverloads</span></div><div class="token-line" style="color:#393A34"><span class="token plain">fun Application.module(testing: Boolean = false) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    initDatabase()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><p>We have to replace the Hash Table used to store the data by the PostgreSQL database (see the final code <a href="https://github.com/evoxmusic/ktor-url-shortener/blob/with_postgresql/src/Application.kt">here</a>)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="deploy-in-the-cloud-with-qovery"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploy-in-the-cloud-with-qovery" title="Direct link to heading">#</a>Deploy in the Cloud with Qovery</h2><p><a href="https://www.qovery.com">Qovery</a> is going to help us to deploy the final application in the Cloud without the need to configure the CI/CD, network, security, load balancing, database and all the DevOps tasks</p><blockquote><p>Qovery is a Container as a Service platform for developer - developers can deploy their application in the Cloud in just a few seconds</p></blockquote><p>Pre-requisites:</p><ul><li>Have an account on Qovery (register <a href="https://www.qovery.com/">here</a>)</li><li>Your code need to be hosted on Github</li><li>You need to <a href="https://github.com/apps/qovery/installations/new">accept the Qovery Github app</a></li><li><a href="https://ktor.io/quickstart/quickstart/docker.html">Package your Ktor application to build and run it on Docker</a></li></ul><p>To deploy on Qovery 2 files are mandatories</p><p>.qovery.yml - a very simple way to declare the dependencies that you need (e.g: PostgreSQL) and where you want to run it (here on AWS and eu-west-3 / Paris)</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-yaml codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> api</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">project</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shortener</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cloud_region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws/eu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">west</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">publicly_accessible</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">databases</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgresql</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;11.5&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pql</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">db</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">routers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> main</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">application_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> api</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /*</span></div></div></pre></div></div><p>Dockerfile - to build and run your application on Qovery</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">FROM openjdk:8-jre-alpine</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ENV APPLICATION_USER ktor</span></div><div class="token-line" style="color:#393A34"><span class="token plain">RUN adduser -D -g </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$APPLICATION_USER</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">RUN </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /app</span></div><div class="token-line" style="color:#393A34"><span class="token plain">RUN </span><span class="token function" style="color:#d73a49">chown</span><span class="token plain"> -R </span><span class="token variable" style="color:#36acaa">$APPLICATION_USER</span><span class="token plain"> /app</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token environment constant" style="color:#36acaa">USER</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$APPLICATION_USER</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">COPY ./build/libs/ktor-url-shortener.jar /app/ktor-url-shortener.jar</span></div><div class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">CMD </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;java&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-server&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-XX:+UnlockExperimentalVMOptions&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-XX:+UseCGroupMemoryLimitForHeap&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-XX:InitialRAMFraction=2&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-XX:MinRAMFraction=2&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-XX:MaxRAMFraction=2&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-XX:+UseG1GC&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-XX:MaxGCPauseMillis=100&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-XX:+UseStringDeduplication&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;-jar&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;ktor-url-shortener.jar&quot;</span><span class="token punctuation" style="color:#393A34">]</span></div></div></pre></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="connect-to-postgresql"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#connect-to-postgresql" title="Direct link to heading">#</a>Connect to PostgreSQL</h3><p>Qovery add dynamically all required environment variables to connect to the database at the runtime of the container.</p><p>To list all of them</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">$ qovery application </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"> list</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  SCOPE    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> KEY                                                          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> VALUE</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_JSON_B64                                              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">base6</span><span class="token operator file-descriptor important" style="color:#393A34">4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_BRANCH_NAME                                           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> with_postgresql</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_IS_PRODUCTION                                         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_NAME                               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> my-pql-db</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_TYPE                               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> POSTGRESQL</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_VERSION                            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11.5</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_CONNECTION_URI                     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_CONNECTION_URI_WITHOUT_CREDENTIALS </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_HOST                               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_FQDN                               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_PORT                               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_USERNAME                           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_PASSWORD                           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_DATABASE_MY_PQL_DB_DATABASE                           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> postgres</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_APPLICATION_API_HOSTNAME                              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BUILT_IN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> QOVERY_APPLICATION_API_HOST                                  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span></div></div></pre></div></div><p>To use them</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-kotlin codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">fun initDatabase() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    val config = HikariConfig().apply {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        jdbcUrl = &quot;jdbc:${System.getenv(&quot;QOVERY_DATABASE_MY_PQL_DB_CONNECTION_URI_WITHOUT_CREDENTIALS&quot;)}&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        username = System.getenv(&quot;QOVERY_DATABASE_MY_PQL_DB_USERNAME&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        password = System.getenv(&quot;QOVERY_DATABASE_MY_PQL_DB_PASSWORD&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        driverClassName = &quot;org.postgresql.Driver&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Database.connect(HikariDataSource(config))</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transaction {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // create tables if they do not exist</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        SchemaUtils.createMissingTablesAndColumns(RequestTable, ClickOverTimeTable)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="deploy"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploy" title="Direct link to heading">#</a>Deploy</h3><p>Deploying your app with Qovery is as simple as commit and push your code.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> .qovery.yml Dockerfile</span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> commit -m </span><span class="token string" style="color:#e3116c">&quot;add .qovery.yml and Dockerfile files&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push -u origin master</span></div></div></pre></div></div><p>To get the public URL</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">$ qovery status</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  BRANCH NAME     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> STATUS  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ENDPOINTS                                   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> APPLICATIONS </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DATABASES </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BROKERS </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> STORAGE</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  with_postgresql </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> running </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://qavcgggy6g6dlkbj-main-gtw.qovery.io </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  APPLICATION NAME </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> STATUS  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ENDPOINT                                                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DATABASES </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BROKERS </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> STORAGE</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  api              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> running </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://ete6bq97amj9n82c-qavcgggy6g6dlkbj-app.qovery.io </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DATABASE NAME </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> STATUS  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> TYPE       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> VERSION </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ENDPOINT </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> PORT     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> USERNAME </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> PASSWORD </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> APPLICATIONS</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  my-pql-db     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> running </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> POSTGRESQL </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11.5</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hidden</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> api</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="conclusion"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#conclusion" title="Direct link to heading">#</a>Conclusion</h2><p>We have seen that creating an URL shortener API with Ktor and Kotlin is extremely simple. The connection of the application with the PostgreSQL database is done in a very easy way with the Exposed library. In just a few lines of code the service is fully functional, and can be deployed in production very quickly with the help of Qovery. In the next part we will see how to create a web interface connecting to this API to convert our URLs without using the curl command.</p><p><strong>Part 2: bind a web interface to the API</strong> - [link coming soon]</p></div></article><nav class="pagination-nav paginator_1WWz"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/guides/advanced/managing-environment-variables"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« Managing env variables</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/guides/advanced/using-multiple-environments"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">Using multiple environments »</h4></a></div></nav></div></main></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col col--5 footer__col"><div class="margin-bottom--md"></div><div class="margin-bottom--md"><p>Qovery accelerates and scales application development cycle with zero infrastructure management investment</p></div><div><a href="https://github.com/qovery" target="_blank"><i class="feather icon-github" alt="Qovery&#x27;s Github Repo"></i></a>    <a href="https://www.linkedin.com/company/qovery/" target="_blank"><i class="feather icon-rss" alt="Qovery&#x27;s Linkedin"></i></a>    <a href="https://twitter.com/qovery_" target="_blank"><i class="feather icon-twitter" alt="Qovery&#x27;s Twitter"></i></a>    <a href="https://discord.qovery.com" target="_blank"><i class="feather icon-message-circle" alt="Qovery&#x27;s Discord"></i></a></div></div><div class="col footer__col"><h4 class="footer__title">Resources</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/pricing" href="https://www.qovery.com/pricing">Pricing</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/enterprise" href="https://www.qovery.com/enterprise">Enterprise</a></li><li class="footer__item"><a class="footer__link-item" to="https://api.qovery.io/swagger-ui.html#" href="https://api.qovery.io/swagger-ui.html#">API</a></li><li class="footer__item"><a class="footer__link-item" to="https://github.com/Qovery" href="https://github.com/Qovery">Github</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://discord.qovery.com" href="https://discord.qovery.com">Discord</a></li><li class="footer__item"><a class="footer__link-item" to="https://roadmap.qovery.com" href="https://roadmap.qovery.com">Roadmap</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Company</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/blog" href="https://www.qovery.com/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/team" href="https://www.qovery.com/team">The Team</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/contact" href="https://www.qovery.com/contact">Contact Us</a></li></ul></div></div><div class="text--center"><small>© 2020 DESIGNED BY QOVERY | BACKED BY TECHSTARS | QOVERY BY BIRDSIGHT - ALL RIGHTS RESERVED</small><br></div></div></footer>
</div>

<script src="/styles.7122513e.js"></script>

<script src="/runtime~main.70364d68.js"></script>

<script src="/main.68867a33.js"></script>

<script src="/1.ccfb3ced.js"></script>

<script src="/2.6fc22653.js"></script>

<script src="/3.f93d080f.js"></script>

<script src="/1c13b173.b03ba391.js"></script>

<script src="/ab8f5b83.972544dc.js"></script>


</body>
</html>